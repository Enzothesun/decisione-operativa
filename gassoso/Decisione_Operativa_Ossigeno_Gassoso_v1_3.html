<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Decisione Operativa – Ossigeno Gassoso</title>
<meta name="color-scheme" content="dark">
<style>
  :root{--bg:#0b0e13;--text:#e9eef5;--muted:#9fb0c7;--card:#141a23;--border:#1d2737;--accent:#4cc2ff;
        --ok:#43d17a;--warn:#ffcc66;--danger:#ff6b6b}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.35}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{font-size:1.6rem;margin:0 0 10px 0}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  label{display:block;font-size:.92rem;color:var(--muted);margin:10px 0 6px}
  input[type="date"],input[type="time"],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #263043;background:#0f1420;color:var(--text)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .toolbar{display:flex;gap:8px;align-items:end;flex-wrap:wrap}
  .btn{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;background:#1b2537;color:var(--text)}
  .btn.primary{background:linear-gradient(135deg,#2968ff,#4cc2ff);color:#fff;font-weight:600}
  .kpi{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;letter-spacing:.2px}
  .kpi.ok{background:rgba(67,209,122,.15);color:var(--ok)}
  .kpi.warn{background:rgba(255,204,102,.15);color:var(--warn)}
  .kpi.danger{background:rgba(255,107,107,.18);color:var(--danger)}
  .muted{color:var(--muted);font-size:.9rem}
  .step{padding:10px 12px;border-left:4px solid #263043;background:#101623;border-radius:8px;margin:8px 0}
  .hint{font-size:.85rem;color:#b5c6de;margin-top:6px}
  .pill{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:#c7d5ea;background:#141a23}
  .footer{color:var(--muted);font-size:.85rem;text-align:center;margin:10px 0 24px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Decisione Operativa – Ossigeno Gassoso <span class="muted" style="font-size:.9rem">v1.3</span></h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Zona</label>
        <select id="zona" onchange="toggleCostiera()">
          <option value="Salerno">Salerno</option>
          <option value="Caserta">Caserta</option>
          <option value="Napoli">Napoli</option>
        </select>
        <div id="costieraWrap" class="hint" style="display:none">
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input id="costiera" type="checkbox"> Area Costiera (Salerno)
          </label>
        </div>
      </div>
      <div>
        <label>Tipologia richiesta</label>
        <select id="tipoRichiesta" onchange="syncTarget()">
          <option value="oggi">In giornata (oggi)</option>
          <option value="successivi">Per i giorni successivi</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Data arrivo chiamata</label>
        <input id="dataCh" type="date">
      </div>
      <div>
        <label>Ora arrivo chiamata</label>
        <input id="oraCh" type="time">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Data di fornitura richiesta</label>
        <input id="dataTg" type="date">
        <div class="hint">Per “oggi” coincide con la data della chiamata</div>
      </div>
      <div>
        <label>Note</label>
        <div class="pill" id="noteTemporali"></div>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" onclick="calcola()">Calcola azione</button>
      <button class="btn" onclick="resetForm()">Reset</button>
      <div class="muted">Regole dai PDF ufficiali (gassoso)</div>
    </div>
  </div>

  <div class="card" id="output" style="display:none">
    <div id="pill" class="kpi">Azione</div>
    <h2 id="titolo" style="margin:8px 0 4px"></h2>
    <div id="motiv" class="muted"></div>
    <div id="steps"></div>
  </div>

  <div class="footer">
    Salerno: feriali ≤15:00 vettore scheda; 15–17 (ven ≤16) piano domani / urgenze a Magaldi (flag Forza controllo, NON chiamare vettore); &gt;17 reperibile.
    Sabato ≤12:00 vettore giro; &gt;12 reperibile; Domenica sempre reperibile. Costiera: sabato sempre reperibile.<br/>
    Napoli/Caserta: feriali ≤15:00 vettore scheda; 15–19 (ven ≤16) contattare Antonio Esposito (palmare); &gt;19 reperibile.
    Sabato ≤12:00 vettore reperibile; &gt;12 reperibile; Domenica sempre reperibile.<br/>
    Giorni successivi Lun–Ven: Infomed vettore di giro (no call).
    Venerdì→Sabato: Salerno ≤16:00 no call; &gt;16 inserimento + BO report; dopo la mail il BO salva/invia le richieste in inserimento;
    le chiamate successive alla mail restano in inserimento ed evadono il sabato mattina. Napoli/Caserta ≤16:00 no call; &gt;16 palmare + evasione telefonica (prima sentire Antonio). Domenica: sempre reperibile.
  </div>
</div>

<script>
/* --- utilità data/ora --- */
function parseYMD(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function toYMD(d){ const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
function addDaysLocal(s,n){ const d=parseYMD(s); d.setDate(d.getDate()+n); return toYMD(d); }
function dayIndexLocal(s){ return parseYMD(s).getDay(); }
function dayNameIt(i){ return ['domenica','lunedì','martedì','mercoledì','giovedì','venerdì','sabato'][i]; }
function pad(n){ return String(n).padStart(2,'0'); }
function nowYMD(){ return toYMD(new Date()); }
function nowHHMM(){ const d=new Date(); return pad(d.getHours())+':'+pad(d.getMinutes()); }
function timeToMins(t){ const [H,M]=t.split(':').map(Number); return H*60+M; }
function daysDiff(a,b){ return Math.round((parseYMD(b)-parseYMD(a))/86400000); }

/* --- init --- */
function setDefaults(){
  const today = nowYMD();
  document.getElementById('zona').value = 'Salerno';
  document.getElementById('tipoRichiesta').value = 'oggi';
  document.getElementById('dataCh').value = today;
  document.getElementById('oraCh').value = nowHHMM();
  document.getElementById('dataTg').value = today;
  toggleCostiera(); updateHints();
}
function syncTarget(){
  const tipo = document.getElementById('tipoRichiesta').value;
  const dataCh = document.getElementById('dataCh').value;
  document.getElementById('dataTg').value = (tipo==='oggi')? dataCh : addDaysLocal(dataCh,1);
  updateHints();
}
function toggleCostiera(){
  const show = document.getElementById('zona').value === 'Salerno';
  document.getElementById('costieraWrap').style.display = show ? 'block':'none';
}
function updateHints(){
  const dch = document.getElementById('dataCh').value;
  const dname = dayNameIt(dayIndexLocal(dch));
  const hh = document.getElementById('oraCh').value || nowHHMM();
  document.getElementById('noteTemporali').textContent = `${dname} • ${hh}`;
}
['dataCh','oraCh','tipoRichiesta'].forEach(id=>{
  document.getElementById(id)?.addEventListener('change', ()=>{ if(id!=='tipoRichiesta') updateHints(); });
});
document.getElementById('dataCh')?.addEventListener('change', syncTarget);

/* --- motore regole --- */
function calcola(){
  const zona = document.getElementById('zona').value;
  const costiera = document.getElementById('costiera')?.checked || false;
  const tipo = document.getElementById('tipoRichiesta').value;
  const dataCh = document.getElementById('dataCh').value;
  const oraCh = document.getElementById('oraCh').value || nowHHMM();
  const dataTg = document.getElementById('dataTg').value;

  const dowCh = dayIndexLocal(dataCh);
  const dowTg = dayIndexLocal(dataTg);
  const hhmm = timeToMins(oraCh);

  const FERIALE = (d)=> (d>=1 && d<=5);
  const isNextDay = (daysDiff(dataCh,dataTg)===1);

  const out = document.getElementById('output'); out.style.display='block';
  const pill = document.getElementById('pill');
  const titolo = document.getElementById('titolo');
  const motiv  = document.getElementById('motiv');
  const steps  = document.getElementById('steps'); steps.innerHTML='';

  const addStep = (t)=>{ const div=document.createElement('div'); div.className='step'; div.textContent=t; steps.appendChild(div); };

  /* === OGGI === */
  if (tipo==='oggi'){
    /* --- SALERNO --- */
    if (zona==='Salerno'){
      if (FERIALE(dowCh)){
        if (hhmm <= timeToMins('15:00')){
          titolo.textContent = "CHIAMA VETTORE DI SCHEDA + inserisci su Infomed (oggi)";
          pill.className='kpi ok'; motiv.textContent="Salerno feriale ≤15:00.";
          addStep("Inserisci la richiesta su Infomed per OGGI (vettore di scheda).");
          addStep("Evadi telefonicamente al vettore di scheda.");
        } else if (hhmm <= timeToMins(dayNameIt(dowCh)==='venerdì'?'16:00':'17:00')){
          titolo.textContent = "Carica sul piano di lavoro del giorno seguente; URGENZE → Magaldi (Forza controllo)";
          pill.className='kpi warn'; motiv.textContent="Salerno feriale 15:00–17:00 (ven fino 16:00).";
          addStep("Inserisci la richiesta sul piano di lavoro del giorno successivo (vettore di giro).");
          addStep("Per richieste urgenti: inserisci la richiesta su Infomed per OGGI e imposta il flag 'Forza controllo customer' per gestione Magaldi. NON chiamare il vettore.");
        } else {
          titolo.textContent = "Contatta REPERIBILE COMMERCIALE (oggi)";
          pill.className='kpi danger'; motiv.textContent="Salerno feriale >17:00 (ven >16:00).";
          addStep("Contatta il reperibile commerciale per autorizzazione alla consegna OGGI.");
          addStep("Se AUTORIZZA: contatta vettore reperibile e inserisci su Infomed con codice reperibile.");
          addStep("Se NON autorizza: invita la farmacia a dare bombole di gassoso che ha presso di sé, oppure – d'accordo con la farmacia – contatta il paziente a recuperare una o più bombole in farmacia.");
          const isFriday = (dayNameIt(dowCh)==='venerdì');
          if (isFriday){
            addStep("Inserisci la consegna per il giorno successivo (SABATO) e lascia la richiesta in 'inserimento'.");
            addStep("A fine turno l’operatore BO invia il report a emergenzapharma@gmail.com.");
            addStep("L’operatore BO, una volta inviata la mail, SALVA/INVIA le richieste che erano in 'inserimento'.");
            addStep("Le chiamate ricevute DOPO l’invio della mail restano in 'inserimento' ed evadono il sabato mattina (operatore primo turno).");
            addStep("Sabato mattina BO salva/invia le richieste in inserimento.");
          } else {
            addStep("Inserisci la consegna per il giorno successivo (feriale).");
          }
        }
      } else if (dayNameIt(dowCh)==='sabato'){
        if (costiera){
          titolo.textContent = "Contatta SEMPRE reperibile commerciale (Costiera – sabato)";
          pill.className='kpi danger'; motiv.textContent="Area Costiera Salerno (sabato).";
          addStep("Contatta reperibile commerciale; se autorizza: vettore reperibile + codice reperibile su Infomed.");
          addStep("Se non autorizza: farmacia + programma primo feriale.");
        } else if (hhmm <= timeToMins('12:00')){
          titolo.textContent = "CHIAMA VETTORE DI GIRO + inserisci su Infomed (oggi, sabato)";
          pill.className='kpi ok'; motiv.textContent="Salerno sabato ≤12:00.";
          addStep("Inserisci su Infomed per OGGI (sabato) sul vettore di giro.");
          addStep("Evadi telefonicamente al vettore di giro.");
        } else {
          titolo.textContent = "Contatta REPERIBILE COMMERCIALE (oggi, sabato >12:00)";
          pill.className='kpi danger'; motiv.textContent="Salerno sabato >12:00.";
          addStep("Reperibile commerciale; se autorizza: vettore reperibile + codice reperibile su Infomed.");
          addStep("Se non autorizza: farmacia + programma primo feriale.");
        }
      } else { /* domenica */
        titolo.textContent = "Contatta REPERIBILE COMMERCIALE (oggi, domenica)";
        pill.className='kpi danger'; motiv.textContent="Salerno domenica.";
        addStep("Reperibile commerciale; se autorizza: vettore reperibile + codice reperibile su Infomed.");
        addStep("Se non autorizza: farmacia + programma primo feriale.");
      }
      return;
    }

    /* --- NAPOLI / CASERTA --- */
    if (zona==='Napoli' || zona==='Caserta'){
      if (FERIALE(dowCh)){
        if (hhmm <= timeToMins('15:00')){
          titolo.textContent = "CHIAMA VETTORE DI SCHEDA + inserisci su Infomed (oggi)";
          pill.className='kpi ok'; motiv.textContent= zona+" feriale ≤15:00.";
          addStep("Inserisci su Infomed per OGGI (vettore di scheda).");
          addStep("Evadi telefonicamente al vettore di scheda.");
        } else if (hhmm <= timeToMins(dayNameIt(dowCh)==='venerdì'?'16:00':'19:00')){
          titolo.textContent = "Contatta ANTONIO ESPOSITO (palmare) e carica correttamente la richiesta";
          pill.className='kpi warn'; motiv.textContent= zona+" feriale 15:00–19:00 (ven fino 16:00).";
          addStep("Contatta Antonio Esposito per indicazioni su quale palmare caricare la richiesta.");
          addStep("Inserisci/assegna la richiesta secondo indicazione (palmare vettore).");
        } else {
          titolo.textContent = "Contatta REPERIBILE COMMERCIALE (oggi)";
          pill.className='kpi danger'; motiv.textContent= zona+" feriale >19:00.";
          addStep("Reperibile commerciale → se autorizza: vettore reperibile + codice reperibile su Infomed.");
          addStep("Se non autorizza: indirizza a farmacia per bombole + programma primo giorno utile.");
        }
      } else if (dayNameIt(dowCh)==='sabato'){
        if (hhmm <= timeToMins('12:00')){
          titolo.textContent = "VETTORE REPERIBILE + Infomed (codice reperibile)";
          pill.className='kpi ok'; motiv.textContent= zona+" sabato ≤12:00.";
          addStep("Inserisci su Infomed per OGGI con codice reperibile.");
          addStep("Evadi telefonicamente al vettore reperibile.");
        } else {
          titolo.textContent = "Contatta REPERIBILE COMMERCIALE (sabato >12:00)";
          pill.className='kpi danger'; motiv.textContent= zona+" sabato >12:00.";
          addStep("Reperibile commerciale; se autorizza: vettore reperibile + codice reperibile.");
          addStep("Se non autorizza: farmacia + programma giorno utile.");
        }
      } else { /* domenica */
        titolo.textContent = "Contatta REPERIBILE COMMERCIALE (oggi, domenica)";
        pill.className='kpi danger'; motiv.textContent= zona+" domenica.";
        addStep("Reperibile commerciale; se autorizza: vettore reperibile + codice reperibile.");
        addStep("Se non autorizza: farmacia + programma giorno utile.");
      }
      return;
    }
  }

  /* === GIORNI SUCCESSIVI === */
  if (tipo==='successivi'){
    /* Lun–Ven (tutte le zone) */
    if ([1,2,3,4,5].includes(dowTg) && daysDiff(dataCh,dataTg)>=1){
      titolo.textContent = "INSERISCI su Infomed (vettore di giro) — NON chiamare il vettore";
      pill.className='kpi warn'; motiv.textContent="Giorni successivi LUN–VEN (tutte le zone).";
      addStep("Inserisci la consegna su Infomed per il giorno richiesto sul vettore di giro.");
      return;
    }

    /* Ven->Sab (next day) */
    if (dayNameIt(dowCh)==='venerdì' && dayNameIt(dowTg)==='sabato' && isNextDay){
      if (zona==='Salerno'){
        if (hhmm <= timeToMins('16:00')){
          titolo.textContent = "Inserisci per SABATO (vettore di giro) — NON chiamare";
          pill.className='kpi warn'; motiv.textContent="Salerno Ven→Sab ≤16:00.";
          addStep("Inserisci su Infomed per sabato sul vettore di giro (senza chiamare il vettore).");
        } else {
          titolo.textContent = "Inserisci per SABATO e lascia in 'INSERIMENTO' + BO report";
          pill.className='kpi warn'; motiv.textContent="Salerno Ven→Sab >16:00.";
          addStep("Inserisci su Infomed per sabato (vettore di scheda) e lascia in 'inserimento'.");
          addStep("BO a fine turno invia report a emergenzapharma@gmail.com.");
          addStep("L’operatore BO, una volta inviata la mail, SALVA/INVIA le richieste lasciate in 'inserimento'.");
          addStep("Le chiamate ricevute dopo la mail restano in 'inserimento' ed evadono telefonicamente il sabato mattina (primo turno).");
          addStep("Sabato mattina BO salva/invia le richieste in inserimento.");
        }
        return;
      }
      if (zona==='Napoli' || zona==='Caserta'){
        if (hhmm <= timeToMins('16:00')){
          titolo.textContent = "Inserisci per SABATO (vettore di giro) — NON chiamare";
          pill.className='kpi warn'; motiv.textContent= zona+" Ven→Sab ≤16:00.";
          addStep("Inserisci su Infomed per sabato sul vettore di giro (senza chiamare).");
        } else {
          titolo.textContent = "Palmare + EVASIONE telefonica (sentire prima Antonio Esposito)";
          pill.className='kpi warn'; motiv.textContent= zona+" Ven→Sab >16:00.";
          addStep("Contatta Antonio Esposito per indicazione del palmare.");
          addStep("Inserisci su Infomed sul palmare indicato ed EVADI telefonicamente al vettore.");
          addStep("Se non evadibile: lascia in inserimento; sabato mattina BO salva/invia.");
        }
        return;
      }
    }

    /* Sab->Dom (next day) - tutte le zone */
    if (dayNameIt(dowCh)==='sabato' && dayNameIt(dowTg)==='domenica' && isNextDay){
      titolo.textContent = "Contatta REPERIBILE COMMERCIALE (consegna DOMENICA)";
      pill.className='kpi danger'; motiv.textContent="Tutte le zone Sab→Dom.";
      addStep("Contatta il reperibile commerciale per autorizzazione.");
      addStep("Se AUTORIZZA: vettore reperibile + codice reperibile su Infomed.");
      addStep("Se NON autorizza: farmacia + inserisci per il primo feriale utile.");
      return;
    }
  }

  /* fallback */
  titolo.textContent = "Verifica con il Customer / Reperibile";
  pill.className='kpi warn';
  motiv.textContent = "Combinazione non esplicitata o non coerente con i PDF (gassoso).";
  addStep("Attenersi alla prassi locale; valutare 'Forza controllo customer' o contattare reperibile commerciale.");
}

function resetForm(){ setDefaults(); document.getElementById('output').style.display='none'; }
setDefaults();
</script>
</body>
</html>
